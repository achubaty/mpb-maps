---
title: "Mountain pine beetle outbreak maps"
author:
- name: "Alex M. Chubaty"
  affiliaton: |
    Canadian Forest Service
    Pacific Forestry Centre  
    506 Burnside Road W  
    Victoria, BC V8Z 1M5
    +1.250.298.2347
    alexander.chubaty@canada.ca
- name: "Eliot J. B. McIntire"
  affiliaton: |
    Canadian Forest Service
    Pacific Forestry Centre  
    506 Burnside Road W  
    Victoria, BC V8Z 1M5
    +1.250.298.2374
    eliot.mcintire@canada.ca
date: "January 20, 2016"
output:
  pdf_document:
    toc: yes
    toc_depth: 3
bibliography: bibliography.bib
---

```{r setup, include=FALSE, message=FALSE}
## determine OS and whether we are on a CFS machine
._CFS_. <- grepl("W-VIC", Sys.info()[["nodename"]])
._OS_. <- Sys.info()[["sysname"]]
._USER_. <- Sys.info()[["user"]]

## set R and knitr options
if (isTRUE(._CFS_.)) {
  options(repos = c(CRAN = "https://cran.rstudio.com/",
                    NRCRAN = "http://132.156.149.95"))
} else {
  options(repos = c(CRAN = "https://cran.rstudio.com/"))
}

knitr::opts_chunk$set(cache = TRUE, cache.path = "cache/", echo = FALSE,
                      message = FALSE, warning = FALSE, fig.path = "figures/")

## attach packages
suppressPackageStartupMessages({
  library(data.table)
  library(devtools)
  library(digest)
  library(magrittr)
  library(maps)
  library(mapdata)
  library(maptools)
  library(plotKML)
  library(raster)
  library(rgdal)
  library(rgeos)
  library(rts)
  library(shapefiles)
  library(snowfall)
  library(spatstat)
  library(RColorBrewer)
})

## additional helper functions
source_url("https://raw.githubusercontent.com/achubaty/r-tools/master/download-data.R")
source_url("https://raw.githubusercontent.com/achubaty/r-tools/master/rdata-objects.R")
source_url("https://raw.githubusercontent.com/achubaty/r-tools/master/sysmem.R")

#' manual garbage collection to free recently unallocated memory 
.cleanup <- function() {
  for (i in 1:10) gc()
}

#' readOGR without having ]to manually change working directory
getOGR <- function(layer, dir) {
  orig.dir <- getwd()
  setwd(dir); on.exit(setwd(orig.dir))
  out <- readOGR(dsn = ".", layer = layer)
  return(out)
}

## set work dirs based on computer used
if (._USER_. == "achubaty") {
  if (._OS_. == "Darwin") {
    maps.dir <- "~/Documents/shared"
    work.dir <- "~/Documents/GitHub/MPB/mpb-maps"
  } else if (._OS_. == "Linux") {
    if (isTRUE(._CFS_.)) {
      maps.dir <- "/mnt/A105388/shared/data"
    } else {
      maps.dir <- "~/Documents/Data/shared"
    }
    work.dir <- "~/Documents/GitHub/MPB/mpb-maps"
  } else if (._OS_. == "Windows") {
    maps.dir <- "//W-VIC-A105388/shared/data"
    work.dir <- "~/GitHub/MPB/mpb-maps"
  } else {
    stop("Which operating system are you using?")
  }
}
setwd(work.dir)
rdata.path <- file.path(maps.dir, "MPB", "Rmaps")
fig.path <- file.path(work.dir, "figures")
if (!dir.exists(fig.path)) dir.create(fig.path)

stopifnot(all(dir.exists(c(fig.path, maps.dir, rdata.path, work.dir))))

## additional options
._NUM_CPUS_. <- parallel::detectCores() / 2 ## max cpus to use

# options below only need to be changed if you want to reprocess the data
# - e.g., you get new MPB map data
# - e.g., you want to change the resolution/extent/etc. of the maps
#        (before rerunning just to change res, can you `clip` out a subset?)
#
._MAPS_USERAW_. <- FALSE  ## read in raw maps from data
._MAPS_REPROJ_. <- FALSE  ## reproject raw maps to `boreal`
._MAPS_MKRSTR_. <- FALSE  ## convert the maps to rasters

._RES_MAPS_. <- 250       ## map resolution, in metres
```

\newpage

## Overview of MPB map data

We use AB `SpatialPoints` data and BC `SpatialPolygons` data.
AB has intensive surveying strategy that covers the whole province, whereas BC uses an extensive surveying approach so polygons provide a better estimate for MPB red attack.
All data are reprojected to match the `boreal` projection and cropped to the study area (currently AB, BC, SK).
When rasterizing, care must be taken to ensure points and polygon data are represented in each pixel at the same scale.
Points data are summed for each pixel, whereas for polygons an average of 1125 stems/ha is used, weighted by the proportion of a pixel overlapped by the polygon.
See @Cooke:2017ms foc more details.

**NOTE:** we have AB aerial survey (point) data up to 2016, but do not have the most recent BC polygon data, thus this file currently only makes use of data up to 2011.

## Canadian administrative boundaries

```{r can_adm}
if (isTRUE(._MAPS_USERAW_.)) {
  adm.path <- file.path(maps.dir, "CAN_adm")
  if (!dir.exists(adm.path)) dir.create(adm.path)
  for (s in 0:3) {
    assign(paste0("CAN_adm", s),
           raster::getData('GADM', path = adm.path, country = "Canada", level = s),
           envir = .GlobalEnv)
    save(list = paste0("CAN_adm", s), file = file.path(adm.path, paste0("CAN_adm", s, ".Rdata")))
  }
}
```

## Canadian boreal forest maps

```{r import-maps-boreal}
if (isTRUE(._MAPS_USERAW_.)) {
  f <- file.path(maps.dir, "boreal", "NABoreal.shp")
  if (!file.exists(f)) {
    url <- "http://cfs.nrcan.gc.ca/common/boreal.zip"
    dl.data(url, dest = maps.dir, unzip = TRUE)
  }
  
  files <- file.path(rdata.path, c("boreal.RData", "boreal.can.RData"))
  if (all(file.exists(files))) {
    lapply(files, load, envir = .GlobalEnv)
  } else {
    boreal <- getOGR("NABoreal", file.path(maps.dir, "boreal"))
    boreal.can <- boreal[boreal$COUNTRY == "CANADA",]
  }
  crs.boreal <- CRS(proj4string(boreal))
  rm(f, files)
  
  west.provs <- c("Alberta", "British Columbia", "Saskatchewan")
  canada1.west <- CAN_adm1[CAN_adm1$NAME_1 %in% west.provs, ]
  canada2.west <- CAN_adm2[CAN_adm2$NAME_1 %in% west.provs, ]

  west.boreal <- spTransform(canada1.west, CRSobj =  crs.boreal)
  west2.boreal <- spTransform(canada2.west, CRSobj =  crs.boreal)
  canada1.boreal <- spTransform(CAN_adm1, CRSobj =  crs.boreal)
  canada2.boreal <- spTransform(CAN_adm2, CRSobj =  crs.boreal)
  boreal.west <- intersect(boreal, west.boreal) %>%
    gBuffer(., byid = TRUE, width = 0)
  
  west.empty.raster <- raster(extent(west.boreal), resolution = ._RES_MAPS_.)
  west.boreal.raster <- suppressWarnings(
    rasterize(west.boreal, west.empty.raster,
              filename = file.path(rdata.path, "west_boreal.grd"),
              overwrite = TRUE)
  )
  
  ### Save these new map objects for later use
  objects2save <- c("boreal", "boreal.can", "boreal.west",
                    "canada1.west", "canada2.west",
                    "canada1.boreal", "canada2.boreal",
                    "west.boreal", "west2.boreal", "west.boreal.raster")
  saveObjects(objects2save, rdata.path)
  rm(list = objects2save)
  rm(objects2save)
  .cleanup()
}
```

## MPB red attack data

### AB `SpatialPoints` data

**NOTE:** this chunk below uses the AB data up to 2011, but we have access to more recent (up to 2016) aerial survey data.
However, because we don't have more recent data (yet) for BC, we stick with using the older data for AB for now.

```{r import-maps-points}
if (isTRUE(._MAPS_USERAW_.)) {
  if (!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal <- CRS(proj4string(boreal))
    rm(boreal)
  }
  suppressWarnings(loadObjects("west.boreal.raster", rdata.path))
  
  ab.pnts.files <- dir(path = file.path(maps.dir, "MPB", "ab_mpb"), pattern = "spot") 
  ab.pnts.dir.shp <- unique(sapply(strsplit(ab.pnts.files, "\\."), function(x) x[[1]]))
  
  ## parallel processing of data
  sfInit(cpus = ._NUM_CPUS_., parallel = TRUE) 
    sfLibrary(magrittr)
    sfLibrary(raster)
    sfLibrary(rgdal)
    sfLibrary(rgeos)
    sfLibrary(sp)
    sfExport("crs.boreal", "getOGR", "maps.dir", "rdata.path", "west.boreal.raster")
       
    ab.pnts.boreal.raster.stack <- sfClusterApplyLB(ab.pnts.dir.shp, function(shp) {
      pnts <- getOGR(shp, dir = file.path(maps.dir, "MPB", "ab_mpb"))
      names(pnts) <- toupper(names(pnts))
      
      ## reproject
      pnts.boreal <- spTransform(pnts, crs.boreal)
      stopifnot(gIsValid(pnts.boreal))
      
      ## rasterize
      yr <- strsplit(shp, "_")[[1]][3] %>% substr(1, 4)
      out <- rasterize(pnts.boreal, west.boreal.raster,
                field = as.numeric(pnts.boreal@data$NUM_TREES), fun = "sum",
                filename = file.path(rdata.path, paste0("MPB_AB_pnts_", yr, ".grd")),
                overwrite = TRUE)
      writeRaster(out, filename = file.path(rdata.path, paste0("MPB_AB_pnts_", yr, ".tif")),
                  overwrite = TRUE)
      return(out)
    }) %>%
      setNames(substr(sapply(strsplit(ab.pnts.dir.shp, "_"), function(x) x[[3]]), 1, 4)) %>%
      stack(filename = file.path(rdata.path, "ab_pnts_boreal.grd"), overwrite = TRUE)
    

    # save these new map objects for later use
    saveObjects("ab.pnts.boreal.raster.stack", rdata.path)
  sfStop()
  
  ## cleanup workspace
  rm(ab.pnts.dir.shp, ab.pnts.files, ab.pnts.boreal.raster.stack, west.boreal.raster)
  .cleanup()
}
```

### BC `SpatialPolygons` data

```{r import-maps-polygons}
if (isTRUE(._MAPS_USERAW_.)) {
  if (!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal <- CRS(proj4string(boreal))
    rm(boreal)
  }
  suppressWarnings(loadObjects("west.boreal.raster", rdata.path))
  
  bc.poly.files <- dir(path = file.path(maps.dir, "MPB", "province_BC"), pattern = "poly") 
  bc.poly.dir.shp <- unique(sapply(strsplit(bc.poly.files, "\\."), function(x) x[[1]])) 
    
  sfInit(cpus = ._NUM_CPUS_., parallel = TRUE) 
    sfLibrary(magrittr)
    sfLibrary(raster)
    sfLibrary(rgdal)
    sfLibrary(rgeos)
    sfLibrary(sp)
    sfExport("._RES_MAPS_.", "crs.boreal", "getOGR", "maps.dir", "rdata.path", "west.boreal.raster")
    
    ## in parallel: load, reproject, and rasterize each of the bc polygons
    #  do as much as possible in a single step (don't save intermediate objects) to minimize RAM use.
    #  total RAM used can be controlled by adjusting the num.cpus used for processing.
    bc.poly.boreal.raster.stack <- sfClusterApplyLB(bc.poly.dir.shp, function(shp) {
      poly.boreal <- getOGR(shp, dir = file.path(maps.dir, "MPB", "province_BC")) %>% 

        ## reproject to boreal projection
        spTransform(., crs.boreal) %>%
        gBuffer(., byid = TRUE, width = 0)
      
      stopifnot(gIsValid(poly.boreal))
      
      ## rasterize
      #  we use 1125 trees/ha, per Whitehead & Russo (2005), Cooke & Carroll (unpublished)
      #  we assign values to the raster based on the proportion of pixel area covered by the polygon
      yr <- strsplit(shp, "_")[[1]][3]
      out <- rasterize(poly.boreal, west.boreal.raster, getCover = TRUE,
                       filename = file.path(rdata.path, paste0("MPB_BC_poly_", yr, ".grd")),
                       overwrite = TRUE) / 100 * 1125 * (._RES_MAPS_. / 100) ^ 2 %>%
        writeRaster(filename = file.path(rdata.path, paste0("MPB_BC_poly_", yr, ".grd")),
                    overwrite = TRUE)
      writeRaster(out, filename = file.path(rdata.path, paste0("MPB_BC_poly_", yr, ".tif")),
                  overwrite = TRUE)
      return(out)
    }) %>% 
      setNames(sapply(strsplit(bc.poly.dir.shp, "_"), function(x) x[[3]])) %>%
      stack(filename = file.path(rdata.path, "bc_poly_boreal.grd"), overwrite = TRUE)

    # save these new map objects for later use 
    saveObjects("bc.poly.boreal.raster.stack", rdata.path)
  sfStop()
  
  # clean up workspace 
  rm(bc.poly.dir.shp, bc.poly.files) 
  .cleanup()
}
```

### Combine AB and BC MPB maps !TODO!

```{r combine-maps-all}
if (isTRUE(._MAPS_MKRSTR_.)) {
  if (!exists("crs.boreal")) {
    loadObjects("boreal", rdata.path)
    crs.boreal <- CRS(proj4string(boreal))
    rm(boreal)
  }

  ### combine bcab points and poly rasters
  loadObjects(c("ab.pnts.boreal.raster.stack", "bc.poly.boreal.raster.stack"), rdata.path)
  
  wh.pnts <- na.omit(match(names(bc.poly.boreal.raster.stack), names(ab.pnts.boreal.raster.stack)))
  wh.poly <- na.omit(match(names(ab.pnts.boreal.raster.stack), names(bc.poly.boreal.raster.stack)))
  
  bcab <- list()
  j <- 0
  for (i in 1:nlayers(bc.poly.boreal.raster.stack)) {
    if (any(names(bc.poly.boreal.raster.stack)[i] == names(ab.pnts.boreal.raster.stack))) {
      j <- j + 1
      if (any(is.finite(cellStats(bc.poly.boreal.raster.stack[[i]], "range")))) {
        bcab[[i]] <- merge(ab.pnts.boreal.raster.stack[[wh.pnts[j]]],
                          bc.poly.boreal.raster.stack[[wh.poly[j]]])
      } else {
        bcab[[i]] <- ab.pnts.boreal.raster.stack[[wh.pnts[j]]]
      }
    } else {
      bcab[[i]] <- bc.poly.boreal.raster.stack[[i]]
    }
  }
  
  bcab <- lapply(bcab, function(x) {
    x[is.na(x)] <- 0; return(x)
  }) %>% lapply(., function(x) {
    x[x > 0] <- log(x[x > 0]) + 10
    return(x)
  }) %>%
    setNames(substr(names(bc.poly.boreal.raster.stack), 2, 5))
  
  bcab.boreal.raster.stack <- stack(bcab, filename = file.path(rdata.path, "bcab.boreal.raster.stack.grd"),
                                    overwrite = TRUE) %>%
    setNames(substr(names(bc.poly.boreal.raster.stack), 2, 5))
  bcab.boreal.raster.brick <- brick(bcab.boreal.raster.stack,
                                    filename = file.path(rdata.path, "bcab.boreal.raster.brick.grd"),
                                    overwrite = TRUE) %>%
    setNames(substr(names(bc.poly.boreal.raster.stack), 2, 5))
  
  writeRaster(bcab.boreal.raster.stack,
              filename = file.path(rdata.path, "mpb_bcab_boreal.tif"),
              overwrite = TRUE) ## TO DO: add options to compress raster depending on size
  
  saveObjects(c("bcab.boreal.raster.brick", "bcab.boreal.raster.stack"), rdata.path)
  
  ## cleanup workspace
  rm(ab.pnts.boreal.raster.stack, bc.poly.boreal.raster.stack,
     bcab, bcab.boreal.raster.brick, bcab.boreal.raster.stack,
     wh.pnts, wh.poly)
  .cleanup()
}
```

## Plotting maps

### Boreal forest maps

**The Canadian boreal forest:**

```{r plot-canada.boreal, fig.height=12, fig.width=16}
loadObjects(c("boreal.can", "canada1.boreal"), rdata.path)
darkgreen <- col2rgb("darkgreen") / 255
col.bor <- rgb(darkgreen[1], darkgreen[2], darkgreen[3], alpha = 0.5)
rm(darkgreen)

plot(canada1.boreal)
plot(boreal.can, col = col.bor, add = TRUE)

png(file.path(fig.path, "boreal.can.png"), type = "cairo", width = 1600, height = 1200)
plot(canada1.boreal)
plot(boreal.can, col = col.bor, add = TRUE)
dev.off()

rm(boreal.can)
```

**The western Canadian boreal forest:**

```{r plot-western.boreal, fig.height=12, fig.width=16}
loadObjects(c("boreal.west", "west.boreal"), rdata.path)
darkgreen <- col2rgb("darkgreen")/255
col.bor <- rgb(darkgreen[1], darkgreen[2], darkgreen[3], alpha = 0.5)
rm(darkgreen)

plot(west.boreal)
plot(boreal.west, col = col.bor, add = TRUE)

png(file.path(fig.path, "boreal.west.png"), type = "cairo", width = 1600, height = 1200)
plot(west.boreal)
plot(boreal.west, col = col.bor, add = TRUE)
dev.off()

rm(boreal.west, west.boreal)
```

### MPB in western Canada

#### MPB `RasterStack`

```{r plot-mpb.western.boreal.raster.stack, fig.height=12, fig.width=12}
loadObjects(c("bcab.boreal.raster.stack", "west.boreal"), rdata.path)
colours <- brewer.pal(n = 9, name = "YlOrRd")
years <- substr(names(bcab.boreal.raster.stack), 2, 5)
last9 <- (length(years) - 8):length(years) # the last 9 years
subset <- last9[last9 > 0]

plot(bcab.boreal.raster.stack, subset, main = years, legend = FALSE, axes = FALSE,
     col = c("white", colours), addfun = function(x) plot(west.boreal, add = TRUE))
#legend("topright", legend = years[subset], fill = colours)

png(file.path(fig.path, "bcab.boreal.raster.stack.png"), type = "cairo",
    width = 2400, height = 1600)
plot(bcab.boreal.raster.stack, subset, main = years, cex.main = 3,
     legend = FALSE, axes = FALSE, col = c("white", colours),
     addfun = function(x) plot(west.boreal, add = TRUE))
#legend("topright", legend = years[subset], fill = colours)
dev.off()

rm(bcab.boreal.raster.stack, west.boreal)
```

#### MPB `RasterBrick` timeseries

```{r plot-mpb.western.boreal.time.series, fig.height=12, fig.width=12}
loadObjects(c("bcab.boreal.raster.brick", "west.boreal"), rdata.path)

# `spsample` needs planar coordinates, so need to reproject to latlong
crs.latlon <- CRS("+proj=longlat +datum=WGS84")
brick.latlon <- projectRaster(bcab.boreal.raster.brick, crs = crs.latlon)

# replace NAs with zeros (WHY??)
brick.latlon <- brick(lapply(1:nlayers(brick.latlon), function(x) {
  brick.latlon[[x]][is.na(brick.latlon[[x]])] <- 0
  return(brick.latlon[[x]])
}))
brick.latlon@title <- "MPB intensity"
brick.latlon <- writeRaster(brick.latlon, filename = file.path(rdata.path, "mpb_brick_latlon.grd"), overwrite = TRUE)

#brick.latlon <- brick(file.path(rdata.path, "mpb_brick_latlon.grd"))
years <- as.numeric(substr(names(bcab.boreal.raster.brick), 2, 5))
t.strt <- as.POSIXct(as.Date(paste(years, "-10-01", sep = "")))     ## why Oct 1?
t.stop <- as.POSIXct(as.Date(paste(years + 1, "-10-01", sep = ""))) ## why Oct 1?

# random sample of spatial points
sps <- spsample(west.boreal, 1, type = "random") %>% 
  spTransform(crs.latlon) %>%
  SpatialPointsDataFrame(data = data.frame(dat = 1))

# colour palette
colours <- brewer.pal(n = 9, name = "YlOrRd")

# `plotKML` timeseries
ts.kml <- new("RasterBrickTimeSeries", variable = "X", sampled = sps, rasters = brick.latlon,
              TimeSpan.begin = t.strt, TimeSpan.end = t.stop)
dims <- dim(brick.latlon)
#plotKML(ts.kml, colour_scale = c(rep("black",2), heat.colors(12)[12:1]),
#        pngwidth = dims[1], pngheight = dims[2], pngpointsize = 14)

# `rts` timeseries
ts.rts <- rts(brick.latlon, time = as.POSIXct(as.Date(t.strt)))
plot(ts.rts, col = c("white", colours)) # this is a *garbage* way to plot a TS

saveObjects(c("brick.latlon", "ts.kml", "ts.rts"), rdata.path)
rm(bcab.boreal.raster.brick, brick.latlon, ts.kml, ts.rts, west.boreal)
.cleanup()
```
